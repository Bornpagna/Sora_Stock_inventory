<?php 
	$tr = Application_Form_FrmLanguages::getCurrentlanguage();
	$form=$this->form_purchase;
	$url_submit = $this->url(array('module'=>'purchase','controller'=>'index','action'=>'add-purchase'));
	$url_cancel = $this->url(array('module'=>'purchase','controller'=>'index','action'=>'index'));
	$url_new = $this->url(array('module'=>'purchase','controller'=>'index','action'=>'add-purchase'));
?>
<title><?php echo $tr->translate("ADD_PURCAHSE_ORDER");?></title>
<div class="wrapper" style="margin-top:-28px;">
    <div class="right" style="width: 99%;">
    	<form id="orderFrm" action="<?php echo $url_submit; ?>" method="post" enctype="multipart/form-data">
    	<div class="contorl-cus">
        	<?php  $frmctrol=$this->control;?>
        	<a href="<?php echo $url_new ?>" class="new"><?php echo $tr->translate("NEW");?></a>
        	<?php 
        		echo $frmctrol->getElement('Save');
			    echo $frmctrol->getElement("SaveNew");
			?>
        	<a href="<?php echo $url_cancel ?>" class="cancel"><?php echo $tr->translate("CANCEL");?></a>
        </div>
			<div class="style-form" style="padding:20px 20px 5px 20px;">
		        <div class="view-table">
				     	<div class="head_form">
					   		<?php echo $tr->translate("VENDOR_INFO");?>
					   	</div>
					   	<div class="contain_form shadow">
					   		<table>
				                <tr>
				                	<td><?php echo $tr->translate("VENDOR_NAME");?></td>
				                    <td width="33%"><?php echo $form->getElement("v_name");?>
				                        <div id='userInfo'></div>
				                    </td>
				                    <td><?php echo $tr->translate("LOCATION_NAME");?></td>
				                    <td width="33%"><?php echo $form->getElement("LocationId");?></td>
				                </tr>
				                <!--<tr>
				                       <?php //echo $form->getElement('contact'); ?>
				                    </td>          
				                    <td><div id = "feedback"></div></td>
					
					<td><?php //echo $form->getElement("order_date");?></td>
				                   
				                </tr>-->
				                 <tr>
				                	<td><?php  echo $tr->translate("DATE_IN"); //echo $tr->translate("CON_NAME");?></td>
				                    <td><?php echo $form->getElement("date_in");?></td>
				                    <td><?php echo $tr->translate("ORDER_DATE");?></td>
					  				<td><?php echo $form->getElement("order_date");?>
				                </tr>
				                <tr>
									<td><?php echo $tr->translate("STATUS");?></td>
				                    <td><?php echo $form->getElement("status");?></td>
				                	<!--<td><?php //echo $tr->translate("CON_NUM");?></td>
				                    <td><?php //echo $form->getElement("txt_phone"); ?></td>-->
									<td><?php echo $tr->translate("ORDER_NUMER");?>
				                    <!--<td><?php //echo $tr->translate("ORDER_DATE");?></td>-->
					 				<td><?php echo $form->getElement("txt_order"); ?></td> 
				                </tr>
				                <tr>
				                	<td><?php //echo $tr->translate("VENDOR_ADD");?></td>
				                    <td><?php //echo $form->getElement("vendor_address");?></td>
				                    <!--<td><?php echo $tr->translate("STATUS");?></td>
				                    <td><?php echo $form->getElement("status");?></td>-->
				                </tr>
				            </table>
					   	</div>
		         </div><!-- end of .view_table -->
		       </div><!-- end of .style form -->
		       
		       <div class="style-form" style="text-align: center;">
				<div class="view-table" style="padding:0 20px;"> 
					<div class="contain_form shadow" style="height: 45px; text-align: left;">
						<div class="blocksearch">
							<select id="add_item" name="add_item" Onchange="getItemOrder();"  class="chosen-select" multiple style="width:80% ;margin:0 auto; text-align: center;" tabindex="4">
								<?php echo $this->items; ?>
							</select>
							<label for="items">&nbsp;&nbsp;FREE</label>
						    <input type="checkbox" Onclick="Confirmmessage()" id="free" name="free" />
						</div>
					</div>
				</div>
			</div>
		       <div id="tabs" class="tabs-bottom">
					<ul style="border-top:1px solid #999;">
						<li><a href="#tabs-1"><?php echo $tr->translate("PURCAHSE_ORDER");?></a></li>
					</ul>
					<div class="tabs-spacer"></div>
					<div id="tabs-1" style="padding: 2px;">
					     	<div class="head_form">
						   		<?php echo $tr->translate("PURCHASE_ORDER_LIST_CAP");?>
						   	</div>
						   	<div class="contain_form">
						   		<div class="view-table table-responsive">
						   		<table class="collape table" id="table_order">
									<tr height="33px">
										<td class="sub-tdheader"><?php echo $tr->translate("DEL");?></td>
										<td class="sub-tdheader"><?php echo $tr->translate("NUM");?></td>
										<td class="sub-tdheader" width="70px"><?php echo $tr->translate("ITEM_NAME_CAP");?></td>
										<td class="sub-tdheader"><?php echo $tr->translate("QTY_UNIT");?></td>
										<td class="sub-tdheader"><?php echo $tr->translate("QTY_PER_UNIT");?></td>
										<td class="sub-tdheader"><?php echo $tr->translate("QTY_ORDER");?></td>
										<td class="sub-tdheader"><?php echo $tr->translate("FREE");?></td>
										<td class="sub-tdheader"><?php echo $tr->translate("UNIT_PRICE_CAP");?></td>
										<td class="sub-tdheader"><?php echo $tr->translate("DISCOUNT");?></td>
										<td class="sub-tdheader"><?php echo $tr->translate("TAx");?></td>
										<!-- <td class="sub-tdheader"><?php //echo $tr->translate("DISCOUNT_CAP");?></td>  -->
										<td class="sub-tdheader"><?php echo $tr->translate("SUB_TOTAL_CAP");?></td>
										<!-- <td class="sub-tdheader"><?php //echo $tr->translate("REMARK_CAP");?></td> -->
									</tr>
								</table>
								</div>
								<input type="hidden" id="identity" name="identity" />
								<table>
									<tr>
										<td class="new-row">
											<div class="btn">
												<button class="positive" type="button" id="new_item"  name= "new_followup" value="New">
													&nbsp;<img src="<?php echo BASE_URL?>/images/icon/new-row.png" alt=""/><?php echo $tr->translate("ADD");?>
												</button>
											</div>
										</td>
									</tr>
								</table>
					            <div class="view-table shadow margin">
									<table style="width:95%; margin:0 auto;">
										
						                <tr class="height">
						                	<td width="2%"><?php echo $tr->translate("PAYMENT_METHOD");?></td>
						                    <td width="30%"><?php echo $form->getElement("payment_name");?></td>
						                    <td width=10%">តម្លៃសរុប​ :</td>
						                    <td width="20%" align="right"><?php echo $form->getElement("totalAmoun");?> </td>
						                </tr>
						                <tr class="height">
						                	<td><?php echo $tr->translate("PRICE_CURRENCY");?></td>
						                    <td> <?php echo $form->getElement("currency");?></td>
						                    <td><?php echo $tr->translate("ពន្ធ");?></td>
						                    <td align="right"><?php echo $form->getElement("total_tax");?></td>
						                </tr>
						                <tr class="height">
						                	<td><span id="ex_label"><?php echo $tr->translate("Exchage Rate");?></span></td>
						                    <td> <?php echo $form->getElement("cur_rate");?></td>
						                    <td><?php echo $tr->translate("DISCOUNT");?></td>
								           <td align="right">
								           		<?php echo $form->getElement("dis_value");?>
								                <input type="hidden" name="global_disc" id="global_disc"/>
								          </td> 
						                </tr>
						                <tr class="height">
						                	<td width="2%"><?php //echo $tr->translate("PAYMENT_METHOD");?></td>
						                    <td width="30%">
						                    	<?php //echo $form->getElement("payment_name");?>
						                    </td>
						                    <td width=10%">សាច់ប្រាក់សរុប​ :</td>
						                    <td width="20%" align="right"><?php echo $form->getElement("all_total");?> </td>
						                </tr>
						                <tr class="height">
						                	<td><?php //echo $tr->translate("PRICE_CURRENCY");?></td>
						                    <td>
						                    	
						                    	<?php echo $tr->translate("REMARK");?>
						                    </td>
						                    <td><?php echo $tr->translate("PAID");?></td>
						                    <td align="right"><?php echo $form->getElement("paid");?></td>
						                </tr>
						                <tr class="height">
						                	<td></td>
						                    <td rowspan="2"><?php echo $form->getElement("remark");?></td>
				
						                    <td><?php echo $tr->translate("BALANCE");?></td>
						                    <td align="right"><?php echo $form->getElement("remain");?></td>
						                </tr>
						                <tr class="height">
						                    <td></td>
						                    <td colspan="2"></td>
						                </tr>
						                <!-- <tr>
						                	<td></td>
						                	<td colspan="3" align="center">
							                	<input class="btn_submit" type="submit" value="<?php echo $tr->translate("SAVE_NEW");?>" name="payment" />
							                    <input class="btn_submit" type="submit" name="payment" value="<?php echo  $tr->translate("SAVE_CLOSE");?>" />
						                        <input class="btn_submit" OnClick="Cancel()" type="button" name="payment" value="<?php echo  $tr->translate("CANCEL");?>" />
						                	</td>
						                </tr> -->
						            </table>	
						         </div>	 <!-- end of .view-table --> 
						   	</div> <!-- end of .contain_form --> 
						 
			</div><!-- end tab1 -->
			
		</div><!-- end of main tab -->	
    	</form>
    </div><!-- end right -->
</div><!-- end wrapper -->
<script>
document.getElementById('ex_label').style.display="none";
document.getElementById('ex_rate').style.display="none";

function getCurrency(){
	var cur_type = $('#currency').val();
	if(cur_type==1){
		document.getElementById('ex_label').style.display="none";
		document.getElementById('ex_rate').style.display="none";
	}else{
		document.getElementById('ex_label').style.display="block";
		document.getElementById('ex_rate').style.display="block";
	}
	//alert(cur_type);
}

function formatCurrency(num) {
	num = num.toString().replace(/\$|\,/g,'');
	if(isNaN(num))
		num = "0";
		sign = (num == (num = Math.abs(num)));
		num = Math.floor(num*100+0.50000000001);
		cents = num%100;
		num = Math.floor(num/100).toString();
	if(cents<10)
		cents = "0" + cents;
		for (var i = 0; i < Math.floor((num.length-(1+i))/3); i++)
			num = num.substring(0,num.length-(4*i+3))+','+
			num.substring(num.length-(4*i+3));
		return (((sign)?'':'-') + '$' + num + '.' + cents);
	}
//action when click on add/delete of followup
var index5 = 0;num=0;
var option5 = '<?php echo $this->items; ?>';
var baseUrl = '<?php echo BASE_URL; ?>';
var template = '';
var value = '';
$("#customer_id").chosen();
$("#add_item").chosen();
pqty = 1;
function addRow(item_id) {
	index5++; //var first = index5;
	//alert(index5);
	for(i=1; i<index5; i++){
		new_item=parseInt(item_id);
		items = parseInt($("#item_id_"+i).val());
		if(new_item==items){
			//pqty=1+parseInt($("#qty"+i).val());
			newqty = parseInt($("#qty_per_unit_"+i).val());
			newqty = newqty+1;
			$("#qty_per_unit_"+i).val(newqty);
			//checkItemQuantity(new_item,pqty);
			
			free = document.getElementById('free');
			control = document.getElementById('pricefree_'+i);
			if((free.checked & control.checked)){
				newqty = parseInt($("#qty_per_unit_"+i).val());
				newqty = newqty+1;
				$("#qty_per_unit_"+i).val(newqty);
				$("#price"+i).val(0);
				 getPriceFree(i);
				getCurrentPrice(i);
				return false;
			}
			else{
			}
			return false;
		}else{
		}
	}
	template='<tr id="row_order_'+index5+'" style="height:33px;">';
	var inp = '';
	if(index5 == 1) {
		template+='<td class="quater-input">&nbsp;</td>';
	} else {
		template+='<td class="quater-input"><img onClick="deleteRecord('+index5+')" src="<?php echo BASE_URL; ?>/images/icon/delete.gif" /></td>';
		//inp = '<input type="text" style="position: relative;margin-top: -15px; top:-15px; width: 211px;" onchange="AddLocation('+index5+')" class="validate[required] ui-autocomplete-input" autocomplete="off" role="textbox" aria-autocomplete="list" aria-haspopup="true" value="'+value+'">';
	}
	template+='<td class="quater-input" width="2%">'+index5+'</td>';
	template+='<td class="quater-input" width="30%"><select Onchange="ShowPopupProduct('+ index5 + ');getTax('+ index5 + ');" id="item_id_'+index5+'" name="item_id_'+index5+'" >'+option5+'</select>'+inp+'</td>';
	template+='<td class="quater-input"><input type="text" onBlur="totalQty('+index5+')" class="validate[required,custom[number]] input" id="qty_unit_'+index5+'" name="qty_unit_'+index5+'" /></td>';
	template+='<td class="quater-input"><input type="text" onBlur="totalQty('+index5+')" class="validate[required,custom[number]] input" value="1" id="qty_per_unit_'+index5+'" name="qty_per_unit_'+index5+'" /></td>';
	template+='<td class="quater-input"><input type="text" onBlur="calculatePrice('+index5+')" class="validate[required,custom[number],onlyNumberSp] input" id="qty'+index5+'" name="qty'+index5+'"/></td>';
	template+='<td class="quater-input"><input type="checkbox" Onclick="getPriceFree('+index5+')" id="pricefree_'+index5+'" name="pricefree_'+index5+'"/> </td>';
	template+='<td class="quater-input"><input type="text" onBlur="calculatePrice('+index5+')" class="validate[required,custom[number]] input" id="price'+index5+'" name="price'+index5+'" /><input type="hidden" id="oldprice_'+index5+'" name="oldprice_'+index5+'"/></td>';
	template+='<td class="quater-input" width="5%"><input type="text" onChange="calculatePrice('+index5+')" id="dis-value'+index5+'" name="dis-value'+index5+'" /><input type="hidden" id="olddis_value_'+index5+'" name="olddis_value_'+index5+'"/><input type="hidden" readonly="readonly" class="input70px" id="real-value'+index5+'" name="real-value'+index5+'" /></td>';
	template+='<td class="quater-input" width="5%"><input type="text" onkeyup="calculatePrice('+index5+')" class="validate[required,custom[number]] input" id="tax'+index5+'" name="tax'+index5+'" style="padding-right:15px; text-align:right; width:58%" /><input type="hidden" name="old_tax'+index5+'" id="old_tax'+index5+'" /><input type="hidden" name="tax_val'+index5+'" id="tax_val'+index5+'" /><label style="margin-left:-15px;">%</label></td>';
	template+='<td class="quater-input"><input type="text" class="input" readonly="readonly" id="total'+index5+'" name="total'+index5+'" /></span></td>';
	//template+='<td class="quater-input"><input type="text" class="input" id="remark_'+index5+'" name="remark_'+index5+'" /></td>';
	//template+='<td class="quater-input"><input type="radio" onChange="calculatePrice('+index5+')" name="dis-type-'+index5+'"  id="dis-type-'+index5+'" value="2" />Fix Value &nbsp;<input type="radio" onChange="calculatePrice('+index5+')" name="dis-type-'+index5+'" id="dis-type2-'+index5+'" value="1" checked="checked" />% &nbsp;<input type="text"  onChange="calculatePrice('+index5+')" class="input70px input" id="dis-value'+index5+'" name="dis-value'+index5+'" /> =<input type="text" readonly="readonly" class="input70px input" id="real-value'+index5+'" name="real-value'+index5+'" /></td>';
	//template+='<td class="quater-input"><input type="text" class="input100px input" readonly="readonly" id="after_discount'+index5+'" name="after_discount'+index5+'" /></td>';
	template+="</tr>";
	$('#table_order').append(template);
	if($('#identity').val()!="") {
		var identity = $('#identity').val();
		$('#identity').val(identity+','+index5);
	} else {$('#identity').val(index5);}
	$("#item_id_"+index5).val(item_id);
	$("#orderFrm").validationEngine();
	$("#item_id_"+index5).chosen();
	getTax(index5);
	//alert(index5);
	if(free.checked){
		$("#pricefree_"+index5).attr({checked:'checked'});  
		$("#price"+index5).val(0);
		$("#price"+index5).attr('readonly','readonly');
		$("#dis-value"+index5).attr('readonly','readonly');
		$("#dis-value"+index5).val(0);
		$('#tax'+index5).val(0);
		$("#tax"+index5).attr('readonly','readonly');
		 //getPriceFree(index);
		//$("#price"+index5).attr({disabled:'disabled'});  ;
		//$("#total"+index5).val(0);
	}
	else{
		$("#dis-value"+index5).val(0);
		$('#dis_value').val(0);
		$('#global_disc').val(0);
		getCurrentPrice(index5);
		//$("#discount_type"+index5).val();
		$("#paid").val(0);
		
	}
	$("#row_order_0").remove();
}

jQuery(document).ready(function(){
	//alert(index5);
	if(index5==0){
		template='<tr id="row_order_'+index5+'" style="height:33px;" >';
		template+='<td colspan="9" align="center">No Record Selected !<td>';
		template+="</tr>";
		$('#table_order').append(template);
	}
});

function getItemOrder(){
	item_ids=$("#add_item").val();
	$('#add_item').val('').trigger("liszt:updated");
	if(item_ids==-1){
		return false;
	}
	addRow(item_ids);
	$("#add_item").val("");
	//getTax();
}

function getPriceFree(index){
	control = document.getElementById('pricefree_'+index);
	if(control.checked){
	//	var comfir= confirm("Ã¡Å¾ï¿½Ã¡Å¾Â¾Ã¡Å¾â€ºÃ¡Å¸â€žÃ¡Å¾â‚¬Ã¡Å¾Â¢Ã¡Å¸â€™Ã¡Å¾â€œÃ¡Å¾â‚¬Ã¡Å¾â€�Ã¡Å¸â€™Ã¡Å¾Å¡Ã¡Å¾Â¶Ã¡Å¾â‚¬Ã¡Å¾Å Ã¡Å¾ï¿½Ã¡Å¾Â¶Ã¡Å¾â€˜Ã¡Å¸â€ Ã¡Å¾â€œÃ¡Å¾Â·Ã¡Å¾â€°Ã¡Å¾â€œÃ¡Å¸ï¿½Ã¡Å¸â€¡ FreeÃ¡Å¾Å¡Ã¡Å¾Âº ? ");
			//if(comfir==true){
				price=$("#price"+index).val();
				$("#oldprice_"+index).val(price);
				$("#price"+index).val(0);
				$("#total"+index).val(0);
				$("#price"+index).attr('readonly','readonly');

				tax=$("#tax"+index).val();
				$("#old_tax"+index).val(tax);
				$('#tax'+index).val(0);
				$("#tax"+index).attr('readonly','readonly');

				dis_value=$("#dis-value"+index).val();
				$("#olddis_value_"+index).val(dis_value);
				$('#dis-value'+index).val(0);
				$("#dis-value"+index).attr('readonly','readonly');
				
				//$('#discount_type'+index).val();
				//document.getElementById('discount_type'+index).disabled=true;
			
				calculatePrice(index);
				doRemain();
			/*}else{
				$("#price"+index).attr('readonly','readonly');
				$("#pricefree_"+index).removeAttr('checked');  
			}*/
			
		}else{
			tax=$("#old_tax"+index).val();
			$("#tax"+index).val(tax);
			$("#tax"+index).removeAttr('readonly','readonly');
			
			price=$("#oldprice_"+index).val();
			$("#price"+index).val(price);
			$("#price"+index).removeAttr('readonly','readonly');

			dis_value=$("#olddis_value_"+index).val();
			$("#dis-value"+index).val(dis_value);
			$("#dis-value"+index).removeAttr('readonly','readonly');
			//$('#discount_type'+index).val();
			calculatePrice(index);   
		}	
}

<?php $url_get_tax =  $this->url(array('module'=>'purchase','controller'=>'index','action'=>'get-tax')); ?>
var record_index= 1;
function getTax(index){
	item_id = $("#item_id_"+ index).val();
		$.ajax({
			        url: "<?php echo $url_get_tax;?>",
			        type: "post",
			        data: {'item_id':item_id},
			        success: function(data){
			            val = $.parseJSON(data);
			            $("#tax"+ index).val(val.purchase_tax);
			        },
			        error:function(){
			            $("#result").html('There is error while submit');
			        }
			    });
}
function deleteRecord(index) {
	var identity = $('#identity').val();
	var arrays = identity.split(',');
	for(var i=0;i<arrays.length;i++) {
		if(arrays[i] == index) arrays.splice(i,1);
	}
	var strings = arrays.join(',');
	$('#identity').val(strings);
	$("#row_order_"+index).remove();
	// total price
	netTotal();
	doTotal();
}
function doTotal() {
	var netTotal = ($('#totalAmoun').val()=='')?0 : $('#totalAmoun').val();
	var discountValue = ($('#dis_value').val());

	tax = $('#total_tax').val();
	if(discountValue.length!=0){
		if(discountValue.indexOf("%")!==-1){
			var pds=discountValue.split("%");
			if(!isNaN(pds[0])){
				var discount=(netTotal*parseFloat(pds[0]))/100;
				//alert(discountValue);
				$("#global_disc").val(discount.toFixed(2));
				//$('#real-value'+index).val(discount.toFixed(2));
				allTotal = netTotal - discount;
				total = parseFloat(allTotal) + parseFloat(tax);
				$('#all_total').val(total.toFixed(2));
				$('#remain').val(total)-$('#paid').val();
			 	doRemain();

			}else{
				
				discount=$('#dis_value').val(0);
				$('#global_disc').val(0);
				//$('#real-value'+index).val(0);
				allTotal = netTotal - discount;
				total = parseFloat(allTotal) + parseFloat(tax);
				$('#all_total').val(total.toFixed(2));
				$('#remain').val(total)-$('#paid').val();
			 	doRemain();
				//$("#ds_con").text('0.00');
			}
		}else{
			if(!isNaN(discountValue)&&discountValue!=0){
				discount = parseFloat(discountValue).toFixed(2);
				$("#dis_value").val(discount);
				//$('#discount_value').val(discount);
				$('#global_disc').val(discount);
				//alert(discount);
				allTotal = netTotal - discount;
				total = parseFloat(allTotal) + parseFloat(tax);
				$('#all_total').val(total.toFixed(2));
				$('#remain').val(total)-$('#paid').val();
			 	//netTotal();
			 	//doTotal();
			 	doRemain();
				
			}else{
				discount=$('#dis_value').val(0);
				$('#dis_value').val(0);
				$('#global_disc').val(0);
				allTotal = netTotal;
				total = parseFloat(allTotal) + parseFloat(tax);
				//alert(allTotal);
				$('#all_total').val(parseFloat(total).toFixed(2));
				$('#remain').val(total)-$('#paid').val();
			 	//netTotal();
			 	//doTotal();
			 	doRemain();
				
				}
		}
	}
	 	
}
function netTotal() {
	// total for all record(total part)
	var cur_type = $('#currency').val();
	var netTotal=0;
	var rowId = $('#identity').val();
	var rowIDArray = rowId.split(',');
	var status = $('#status').val();
	
	//alert(status);
	for(var n = 0; n < rowIDArray.length; n++) {
		netTotal += Number($('#total'+rowIDArray[n]).val());
	}

	if(cur_type==1){
		$('#totalAmoun').val(netTotal.toFixed(2));
		//$('#totalAmoun').text('$' + parseFloat(netTotal, 10).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, "$1,").toString());
	}else if(cur_type==2){
		netTotal = netTotal * $('#ex_rate').val();
		$('#totalAmoun').val(netTotal.toFixed(2));
		//$('#totalAmoun').text('$' + parseFloat(netTotal, 10).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, "$1,").toString());
	}else if(cur_type==3){
		netTotal = netTotal * $('#ex_rate').val()
		$('#totalAmoun').val(netTotal.toFixed(2));
		//$('#totalAmoun').val('$' + parseFloat(netTotal, 10).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, "$1,").toString());
	}
	
	
	if(status == 4){
		//alert(status);
		
		$('#paid').val(netTotal.toFixed(2));
		$("#paid").attr('readonly','readonly');
		$('#remain').val(0);
		//$("#remain").attr('readonly','readonly');
	}else{
		//alert(status);
		$('#paid').val(0);
		$("#paid").removeAttr('readonly','readonly');
		$('#remain').val(netTotal.toFixed(2));
		//$("#remain").removeAttr('readonly','readonly');
	}
	doTotal();
}

function netTax() {
	// total for all record(total part)
	
	var netTax=0;
	var rowIds = $('#identity').val();
	var rowIDArrays = rowIds.split(',');
	for(var n = 0; n < rowIDArrays.length; n++) {
		netTax += Number($('#tax_val'+rowIDArrays[n]).val());
		//alert(netTax);
	}
	$('#total_tax').val(netTax);
	
}
function doRemain() {
	// total for all record(total part)
	var status = $('#status').val();
	var remain_total = $('#remain').val();
	var paid = $('#paid').val();
	//var remain; 
	if(status == 4){
		$('#remain').val(0);
	}else{
		remain = remain_total-paid;
		$('#remain').val(remain.toFixed(2));
	}
}
function totalQty(index){
	calculatePrice(index);
	getQtyById(index);
}
// Calculate price of order
function calculatePrice(index) {


	var qty = $('#qty'+index).val();
	var price = $('#price'+index).val();
	var total = price * qty;
	var ds = $('#dis-value'+index).val();
	var tax = $('#tax'+index).val();
	var t_tax = (total * tax)/100;

	$('#tax_val'+index).val(t_tax);
	
	if(ds.length!=0){
		if(ds.indexOf("%")!==-1){
			var pds=ds.split("%");
			if(!isNaN(pds[0])){
				var discount=(total*parseFloat(pds[0]))/100;
				//alert(discount);
				//$("#discount_value").val(discount.toFixed(2));
				$('#real-value'+index).val(discount.toFixed(2));
				after_discount = total - discount;
				$('#total'+index).val(after_discount.toFixed(2));
			 	netTotal();
			 	doTotal();
			 	doRemain();

			}else{
				
				discount=$('#dis-value'+index).val(0);
				//$('#discount_value').val(0);
				$('#real-value'+index).val(0);
				after_discount = total - discount;
				$('#total'+index).val(after_discount.toFixed(2));
			 	netTotal();
			 	doTotal();
			 	doRemain();
				//$("#ds_con").text('0.00');
			}
		}else{
			if(!isNaN(ds)&&ds!=0){
				discount = parseFloat(ds).toFixed(2);
				$("#dis-value"+index).val(discount);
				//$('#discount_value').val(discount);
				$('#real-value'+index).val(discount);
				//alert(discount);
				after_discount = total - discount;
				//alert(total);
				$('#total'+index).val(after_discount.toFixed(2));
			 	netTotal();
			 	doTotal();
			 	doRemain();
				
			}else{
				discount=$('#dis-value'+index).val(0);
				//$('#discount_value').val(0);
				$('#real-value'+index).val(0);
				after_discount = total;
				//alert(after_discount);
				$('#total'+index).val(parseFloat(after_discount).toFixed(2));
			 	netTotal();
			 	doTotal();
			 	doRemain();
				
				}
		}
	}
	netTax();
	// total price
// 	var price = $('#price'+index).val();
// 	var qty = $('#qty'+index).val();
// 	var tax = $('#tax'+index).val();
	 
// 	var total = price * qty;
// 	var t_tax = (total * tax)/100;
// 	all_total = total+t_tax;
// 	//alert(all_total);
// 	$('#tax_val'+index).val(t_tax);
// 	$('#total'+index).val(total);
// 	// discount of total price
// 	var disType = $('input:radio[name=dis-type-'+index+']:checked').val();
// 	var disValue = ($('#dis-value'+index).val() == '')? 0 : $('#dis-value'+index).val();
// 	var discount = (disType == 1)? total * disValue / 100 : disValue;
// 	$('#real-value'+index).val(discount);
// 	var lastTotal = $('#total'+index).val() - discount;
// 	$('#after_discount'+index).val(lastTotal);
// 	// total price
 	
// 	netTotal();
// 	doTotal();
	
}
</script>
<?php  //$url_check =  $this->url(array('module'=>'purchase','controller'=>'Index','action'=>'check'));?>
<script type = "text/javascript">
			/*$(document).ready(function(){ //when the document is ready, run the function
				$('#feedback').load('<?php //echo $url_check?>').show();
				$('#txt_order').keyup(function(){

					$.post('<?php //echo $url_check;?>', { username: orderFrm.txt_order.value },
						function(result){
							$('#feedback').html(result).show();
						});
				});
			});*/
</script>
<!-- end new product -->
<div id="overlay" class="web_dialog_overlay"></div>
<?php $frm_product= $this->form;?>
		<div id="dialog" class="web_dialog">
		<form id="frm1">
			<div class="web_dialog_title" align="center"><?php echo $tr->translate("ADD_NEW_ITEM");?>
				<a href="#" id="btnClose" class="cancelDailog"></a>
			</div>
			<table style="width: 95%; margin:0 auto;" cellpadding="3" cellspacing="0">
				
				<tr>
					<td><?php echo $tr->translate("ITEM");?></td>
					<td><?php echo $frm_product->getElement("txt_name");?></td>
				</tr>
				<tr>
					<td><?php echo $tr->translate("ITEM_CODE");?></td>
					<td><?php echo $frm_product->getElement("item_code");?></td>
				</tr>
				<tr>
					<td><?php echo $tr->translate("CATEGORY_NAME");?></td>
					<td><?php echo $frm_product->getElement("category_id");?></td>
				</tr>
				<tr>
					<td><?php echo $tr->translate("BRANCH_NAME");?></td>
					<td><?php echo $frm_product->getElement("brand_id");?></td>
				</tr>
				<tr>
					<td><?php echo $tr->translate("DESC");?></td>
					<td><?php echo $frm_product->getElement("remark_order");?></td>
				</tr>
				<tr>
					<td colspan="2" style="text-align: center;">
						<input id="btn_add" Onclick="addProduct()" type="button" value="<?php echo $tr->translate("ADD_NEW");?>" />
						<input id="btnCancel" class="cancelDailog" type="button" value="<?php echo $tr->translate("CANCEL");?>" />
					</td>
				</tr>
	       </table>
	     </form>
 </div>
 <!-- add new location -->
<!-- end new product -->
<div id="overlay-location" class="web_dialog_overlay"></div>
		<?php $form_stock = $this->form_addstock; ?>
		<div id="dialog-location" class="web_dialog">
		<form id="frm-location">
			<div class="web_dialog_title" align="center"><?php echo $tr->translate("ADD_NEW_LOCATION");?>
				<a href="#" id="btnCloseLocation" class="cancelDailog"></a>
			</div>
			<table style="width: 95%; margin:0 auto;" cellpadding="3" cellspacing="0">
				<tr>
					<td><?php echo $tr->translate("LOCATION_NAME");?></td>
					<td><?php echo $form_stock->getElement("StockName");?></td>
					<td><?php echo $tr->translate("CON_NAME");?></td>
					<td><?php echo $form_stock->getElement("ContactName");?></td>
				</tr>
				<tr>
					<td><?php echo $tr->translate("CON_NUM");?></td>
					<td><?php echo $form_stock->getElement("ContactNumber");?></td>
					<td><?php echo $tr->translate("STOCK_ADD");?></td>
					<td><?php echo $form_stock->getElement("location_add");?></td>
				</tr>
				<tr>
					<td colspan="2"></td>
					<td><?php echo $tr->translate("DESC");?></td>
					<td><?php echo $form_stock->getElement("description");?></td>
				</tr>
				<tr>
					<td colspan="2" style="text-align: center;">
						<input id="btn_add" Onclick="addNewLocation()" type="button" value="<?php echo $tr->translate("ADD_NEW");?>" />
						<input id="btncancel_location" class="cancelDailog" type="button" value="<?php echo $tr->translate("CANCEL");?>" />
					</td>
					<td colspan="2"></td>
				</tr>
	       </table>
	     </form>
 </div>
  <!-- add new customer -->
<div id="overlay-vendor" class="web_dialog_overlay"></div>
<?php $frm_vendor= $this->form_vendor;?>
		<div id="dialog-vendor" class="web_dialog">
		<form id="frmvendor">
			<div class="web_dialog_title" align="center"><?php echo $tr->translate("ADD_NEW_VENDOR");?>
				<a href="#" id="btnClosevendor" class="cancelDailog"></a>
			</div>
			<table style="width: 98%; margin:0 auto;" cellpadding="3" cellspacing="0">
				
				<tr>
					<td width="70px"><?php echo $tr->translate("VENDOR_NAME");?></td>
					<td><?php echo $frm_vendor->getElement("vendor_name");?></td>
					<td><?php echo $tr->translate("CON_NAME");?></td>
					<td><?php echo $frm_vendor->getElement("txt_contact_name");?></td>
				</tr>
				<tr>
					<td><?php echo $tr->translate("CON_NUM");?></td>
					<td><?php echo $frm_vendor->getElement("v_phone");?></td>
					<td><?php echo $tr->translate("VENDOR_ADD");?></td>
					<td rowspan="2"><?php echo $frm_vendor->getElement("txt_address");?></td>
				</tr>
				<tr>
					<td><?php echo $tr->translate("EMAIL");?></td>
					<td><?php echo $frm_vendor->getElement('txt_mail');?></td>
					<td></td>
				</tr>
				<tr>
					<td></td>
					<td></td>
					<td colspan="2">
						<input id="btn_add" Onclick="addNewVendor()" type="button" value="<?php echo $tr->translate("ADD_NEW");?>" />
						<input id="btnCancelVendor" class="cancelDailog" type="button" value="<?php echo $tr->translate("CANCEL");?>" />
					</td>
					
				</tr>
	       </table>
	     </form>
 </div>

<script>
//show popup
//for add new product
 var record_id = 1;
function ShowPopupProduct(index){
	item_id = $("#item_id_"+ index).val();
	record_id = index;
	if(item_id==-1){
		ShowDialog(true);
	}
	else{
		
		getQtyById(index);
	}
	
}
<?php $url_add_new =  $this->url(array('module'=>'product','controller'=>'index','action'=>'add-new')); ?>
function addProduct(){
	var pro_name = $("#txt_name").val();
	var pro_code = $("#item_code").val();
	var category_id = $("#category_id").val();
	var brand_id = $("#brand_id").val();
	var remark = $("#remark_order").val();
	validate_text('#txt_name');
	validate_text('#item_code');
		$.ajax({
	        url: "<?php echo $url_add_new;?>",
	        type: "post",
	        data: {'pro_name':pro_name,'pro_code':pro_code,'category_id':category_id,'brand_id':brand_id,'remark':remark},
	        success: function(data){
	           val = $.parseJSON(data);
	           $('#item_id_'+record_id).append($('<option></option>').attr('value',val['pid']).attr("selected",true).text(pro_name)); 
	           $('#item_id_'+record_id).trigger("liszt:updated");
	            document.getElementById("frm1").reset();
	            HideDialog();
	        },
	        error:function(){
	            $("#result").html('There is error while submit');
	        }
	    });	
}
//////////////////vendor get vendor info or add new
<?php $url_get_customer =  $this->url(array('module'=>'purchase','controller'=>'index','action'=>'get-customer-info')); ?>
function getCustomerInfo(){
	var vendor_id = $("#v_name").val();
	if(vendor_id==-1){
			  ShowVendorDialog(true);
			 
	  }
	else{
		$.ajax({
	        url: "<?php echo $url_get_customer;?>",
	        type: "post",
	        data: {'vendor_id':vendor_id},
	        success: function(data){
	            //alert(data);
	            val = $.parseJSON(data);
	            $("#contact").val(val.contact_name);
	            $("#txt_phone").val(val.phone);
	            $("#vendor_address").val(val.address);
	        },
	        error:function(){
	           // alert("Please Select Vendor");
	            $("#result").html('There is error while submit');
	        }
	    });
	}
}
<?php $url_add_vendor =  $this->url(array('module'=>'purchase','controller'=>'vendor','action'=>'add-vendor')); ?>
function addNewVendor(){
	var v_name  = $("#vendor_name").val();
	var contact = $("#txt_contact_name").val();
	var phone   = $("#v_phone").val();
	var address = $("#txt_address").val();
	var txt_mail= $("#txt_mail").val();
	validate_text('#vendor_name');
	$.ajax({
        url: "<?php echo $url_add_vendor;?>",
        type: "post",
        data: {'v_name':v_name,'contact':contact,'phone':phone,'address':address,'txt_mail':txt_mail},
        success: function(data){
            val = $.parseJSON(data);
	        $('#v_name').append($("<option></option>").attr("value",val['vid']).attr("selected",true).text(v_name));  
            $("#contact").val(contact);
            $("#txt_phone").val(phone);   
            $("#vendor_address").val(address);     
           // $('#v_name').next().val(v_name);
            document.getElementById("frmvendor").reset();
            HideDialogVendor();
        },
        error:function(){
            alert("faile insert");
            $("#result").html('There is error while submit');
        }
    });
}
//Add location or check popup location
function AddLocation(){
	var location_id= $("#LocationId").val();
	if(location_id==-1){
		     AddNewLocation(true);
			 
	  }	
}
<?php $url_add_location =  $this->url(array('module'=>'product','controller'=>'index','action'=>'add-new-location')); ?>
function addNewLocation(){
	var location_name = $("#StockName").val();
	var ContactName   = $("#ContactName").val();
	var ContactNumber = $("#ContactNumber").val();
	var location_add  = $("#location_add").val();
	var remark_add    = $("#description").val();
	validate_text('#StockName');
	$.ajax({
        url: "<?php echo $url_add_location;?>",
        type: "post",
        data: {'location_name':location_name,'ContactName':ContactName,'ContactNumber':ContactNumber,'location_add':location_add,'remark_add':remark_add},
        success: function(data){
           val = $.parseJSON(data);
           
            $('#LocationId').append($("<option></option>").attr("value",val['LocationId']).attr("selected",true).text(location_name)); 
            //$('#LocationId').next().val(location_name);
            document.getElementById("frm-location").reset();
            HideDialoglocation();
        },
        error:function(){
            alert("faile insert");
            $("#result").html('There is error while submit');
        }
    });
 
}
function Cancel(){
	var comfir= confirm("តើអ្នកពិតជាចង់ចាកចេញរឺ? ");
	if(comfir==true){
		window.open("<?php echo BASE_URL;?>/purchase/index/index","_parent");
	}
	
}
<?php $url_code =  $this->url(array('module'=>'purchase','controller'=>'index','action'=>'check-purchaseno')); ?>
function CheckPOInvoice(){
				pur_no=$("#txt_order").val();
				if(pur_no=="" || pur_no ==null){
					return false;
				}
				else{
				$.ajax({
						url:"<?php echo $url_code;?>",
						type:"post",
						data:{'pur_no':pur_no},
						success: function(data){
							value = $.parseJSON(data);
							if(value=="" || value==null){
							}
							else{
								alert("Invoice number is exist !");
								$("#txt_order").css("border-color","red");
								$("#txt_order").val("");
							}
							
						},
						error:function(){
						}
					});
				}
				
			}

<?php $url_qty =  $this->url(array('module'=>'purchase','controller'=>'index','action'=>'getqtybyid')); ?>
function getQtyById(index){
				item_id=$("#item_id_"+index).val();
				qty_unit=$("#qty_unit_"+index).val();
				qty_per_unit=$("#qty_per_unit_"+index).val();
				if(qty_unit==null || qty_unit==""){
					if(qty_per_unit!==null && qty_per_unit!==""){
						$("#qty"+index).val(qty_per_unit);
					}
				}else{
					$.ajax({
						url:"<?php echo $url_qty;?>",
						type:"post",
						data:{'item_id':item_id},
						success: function(data){
							item_qty = $.parseJSON(data);
							qty_unit=$("#qty_unit_"+index).val();
							totalqty=qty_unit*item_qty['qty_perunit'];
// 							if(qty_per_unit>item_qty['qty_perunit']){
// 								qty_unit1=qty_per_unit/item_qty['qty_perunit'];
// 								total_qty_unit = qty_unit + qty_unit1;
// 								$("#qty_unit_"+index).val(total_qty_unit);
// 							}
							
							if(qty_per_unit==null || qty_per_unit==""){
								//$("#qty"+index).val(qty_per_unit);
							}
							else{
								qtyunit = parseInt($("#qty_per_unit_"+index).val());
								totalqty = qty_unit*item_qty['qty_perunit'] +qtyunit;
							}
							//$("#qty"+index).val(totalqty);
							$("#qty"+index).val(totalqty);
							
						},
						error:function(){
						}
					});
				}
				
			}
//add vendor
</script>								    